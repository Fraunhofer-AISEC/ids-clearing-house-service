<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:camel="http://camel.apache.org/schema/spring"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
          http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
          http://camel.apache.org/schema/spring
          http://camel.apache.org/schema/spring/camel-spring.xsd">

    <camel:sslContextParameters id="ChSslContext">
        <camel:keyManagers keyPassword="password">
            <camel:keyStore resource="etc/keystore.p12" password="password"/>
        </camel:keyManagers>
        <camel:trustManagers>
            <camel:keyStore resource="etc/truststore.p12" password="password"/>
        </camel:trustManagers>
    </camel:sslContextParameters>

    <!-- Beans -->
    <bean id="CHOutputProcessor" class="de.fhg.aisec.ids.clearinghouse.ClearingHouseOutputProcessor" />
    <bean id="MultipartOutputProcessor" class="de.fhg.aisec.ids.clearinghouse.MultipartOutputProcessor" />
    <bean id="InfoModelParsingProcessor" class="de.fhg.aisec.ids.clearinghouse.ClearingHouseInfomodelParsingProcessor" />
    <bean id="TokenValidationProcessor" class="de.fhg.aisec.ids.clearinghouse.TokenValidationProcessor" />
    <bean id="idscp2Processor" class="de.fhg.aisec.ids.clearinghouse.ClearingHouseIdscp2InputProcessor" />
    <bean id="MultipartInputProcessor" class="de.fhg.aisec.ids.camel.multipart.MultiPartInputProcessor" />
    <bean id="TypeExtractionProcessor" class="de.fhg.aisec.ids.camel.processors.IdsMessageTypeExtractionProcessor" />


    <!-- Routes -->
    <camelContext xmlns="http://camel.apache.org/schema/spring">
        <restConfiguration scheme="https" component="jetty" host="0.0.0.0" port="9999" bindingMode="off">
            <endpointProperty key="sslContextParameters" value="#ChSslContext"/>
        </restConfiguration>
        <rest id="CH_REST">
            <post uri="/messages/query/{pid}" id="CH_QUERY_PID">
                <to uri="direct:multipart" />
            </post>
            <post uri="/messages/query/{pid}/{id}" id="CH_QUERY_PID_ID">
                <to uri="direct:multipart" />
            </post>
            <post uri="/messages/log/{pid}" id="CH_LOG_PID">
                <to uri="direct:multipart" />
            </post>
            <post uri="/process/{pid}" id="CH_CREATE_PID">
                <to uri="direct:multipart" />
            </post>
        </rest>

        <route id="CH_MULTIPART_ROUTE">
            <from uri="direct:multipart"/>
            <onException>
                <exception>java.io.IOException</exception>
                <exception>java.lang.SecurityException</exception>
                <exception>java.lang.IllegalArgumentException</exception>
                <handled>
                    <constant>true</constant>
                </handled>
                <transform><simple>${exception.message}</simple></transform>
                <log message="### Handle ${exception.class} ###"/>
                <removeHeader name="idsMultipartHeader"/>
                <removeHeader name="pid"/>
                <choice>
                    <when>
                        <simple>${exception.class} == 'java.lang.SecurityException'</simple>
                        <setHeader name="CamelHttpResponseCode"><simple>401</simple></setHeader>
                    </when>
                    <when>
                        <simple>${exception.class} == 'java.io.IOException' || ${exception.class} == 'java.lang.IllegalArgumentException'</simple>
                        <setHeader name="CamelHttpResponseCode"><simple>400</simple></setHeader>
                    </when>
                    <otherwise>
                        <setHeader name="CamelHttpResponseCode"><simple>500</simple></setHeader>
                        <transform><constant>Internal Server Error</constant></transform>
                    </otherwise>
                </choice>
            </onException>
            <process ref="MultipartInputProcessor" />
            <process ref="InfoModelParsingProcessor" />
            <process ref="TokenValidationProcessor" />
            <to uri="http://clearing-house-api:8000/?bridgeEndpoint=true&amp;throwExceptionOnFailure=false" />
            <process ref="CHOutputProcessor" />
            <process ref="MultipartOutputProcessor" />
        </route>
        
    </camelContext>
</beans>
